<!DOCTYPE html>
<html>
  <head>
    <title>PDF Worker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
  </head>
  <body>
    <script>
      // This is the code that will run inside the iframe.
      window.onload = function () {
        // Listen for messages from the parent window (your Next.js component).
        window.addEventListener("message", async (event) => {
          if (event.data.type === "process-pdf") {
            try {
              const pdfData = event.data.file;
              const typedArray = new Uint8Array(pdfData);

              // Set the worker source. This works because it's a new environment.
              pdfjsLib.GlobalWorkerOptions.workerSrc =
                window.location.origin + "/pdf/pdf.worker.min.js";

              const pdf = await pdfjsLib.getDocument({ data: typedArray })
                .promise;
              let text = "";
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map((item) => item.str).join(" ");
              }

              // Send the extracted text back to the parent window.
              window.parent.postMessage(
                { type: "pdf-result", text: text },
                "*"
              );
            } catch (e) {
              window.parent.postMessage(
                { type: "pdf-error", error: e.toString() },
                "*"
              );
            }
          }
        });
      };
    </script>
  </body>
</html>
